# Ralph Progress Log

## Codebase Patterns

- **Migration files**: Located at `apps/studio/drizzle/migrations/` with naming convention `XXXX_description.sql`
- **SQLite column naming**: Uses snake_case for columns (e.g., `first_name`, `created_at`)
- **Timestamps**: Use `text` type with `DEFAULT (datetime('now'))` for SQLite compatibility
- **Foreign keys**: Defined inline with column using `FOREIGN KEY ... REFERENCES` syntax
- **Indexes**: Created with `--> statement-breakpoint` separator between SQL statements
- **JSON fields**: Stored as `text` type (SQLite doesn't have native JSON type)
- **Pre-existing issues**: Typecheck error exists in Login.tsx:52 on main branch

---

## Iterations

### Iteration: 2026-01-20

**Story:** US-001 - Create email marketing database schema migration
**Status:** Complete

**What was done:**

- Created migration file at `drizzle/migrations/0005_add_email_marketing.sql`
- Implemented 8 tables: `subscribers`, `segments`, `segment_subscribers`, `email_templates`, `email_components`, `campaigns`, `email_sends`, `email_events`
- Added proper foreign key relationships between tables
- Created indexes on frequently queried columns (email, shopify_customer_id, status, campaign_id)
- Verified build passes (typecheck has pre-existing error unrelated to this change)

**Files changed:**

- `apps/studio/drizzle/migrations/0005_add_email_marketing.sql` (created)
- `backlog/backlog.json` (updated passes status)

**Learnings for future iterations:**

- SQLite uses `text` type for JSON data, datetime, and enums
- Migration file uses `--> statement-breakpoint` to separate SQL statements
- Build verification is sufficient when typecheck has pre-existing errors on main
- Status enum values are stored as text strings in SQLite (not native enums)

### Iteration: 2026-01-20 (continued)

**Story:** US-002 - Add Drizzle schema definitions for email marketing tables
**Status:** Complete

**What was done:**

- Added 8 Drizzle table definitions to `apps/studio/server/db/schema.ts`
- Tables defined: `subscribers`, `segments`, `segmentSubscribers`, `emailTemplates`, `emailComponents`, `campaigns`, `emailSends`, `emailEvents`
- Added Drizzle relations for all table relationships using `relations()` helper
- Exported Select and Insert types for each table (e.g., `Subscriber`, `NewSubscriber`)
- Used `text()` with `enum` option for status fields to match SQLite storage
- Verified build passes successfully

**Files changed:**

- `apps/studio/server/db/schema.ts` (modified - added 251 lines)
- `backlog/backlog.json` (updated US-002 passes status)

**Learnings for future iterations:**

- Drizzle uses `primaryKey({columns: [...]})` for composite primary keys in SQLite
- Relations are defined separately from tables using `relations()` from drizzle-orm
- Type inference uses `$inferSelect` and `$inferInsert` on table definitions
- Enum options in text() provide TypeScript typing but store as plain text in SQLite

### Iteration: 2026-01-20 (continued)

**Story:** US-003 - Create subscriber CRUD API routes
**Status:** Complete

**What was done:**

- Created `apps/studio/server/routes/email.ts` with subscriber CRUD endpoints
- Implemented `GET /api/email/subscribers` with pagination and filters (status, search, segmentId)
- Implemented `GET /api/email/subscribers/:id` returning subscriber with segment memberships
- Implemented `POST /api/email/subscribers` with email validation and duplicate checking
- Implemented `PATCH /api/email/subscribers/:id` for updating subscriber fields
- Implemented `DELETE /api/email/subscribers/:id` as soft-delete (sets status to 'unsubscribed')
- Registered email routes in `apps/studio/server/index.ts`
- All routes require authentication via authMiddleware

**Files changed:**

- `apps/studio/server/routes/email.ts` (created)
- `apps/studio/server/index.ts` (modified - added email routes)
- `backlog/backlog.json` (updated US-003 passes status)

**Learnings for future iterations:**

- Hono routes follow pattern: create Hono instance, apply middleware, define routes, export
- Status enum fields need explicit type assertion when comparing with query params (string â†’ enum type)
- Drizzle `inArray` operator useful for filtering by segment membership
- Use zValidator from @hono/zod-validator for request body validation
- Soft deletes preferred for subscriber management to preserve data integrity

