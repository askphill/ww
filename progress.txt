# Ralph Progress Log

## Codebase Patterns
<!-- Ralph will add discovered patterns here -->

---

## Iterations

### Iteration: 2026-01-13
**Story:** US-001 - Create AddedToBagPopup component structure
**Status:** Complete

**What was done:**
- Created AddedToBagPopup component at apps/website/app/components/AddedToBagPopup.tsx
- Defined AddedToBagPopupProduct interface with image, title, variantTitle, price, currencyCode
- Defined AddedToBagPopupProps interface with isOpen, onClose, product, cartCount, checkoutUrl
- Component returns null when isOpen is false or product is null
- Basic placeholder UI structure added

**Files changed:**
- apps/website/app/components/AddedToBagPopup.tsx (new)

**Learnings for future iterations:**
- Pre-existing typecheck errors exist in @wakey/seo-engine and other packages (not related to website)
- Use `pnpm build --filter=@wakey/website` to verify just the website package builds successfully
- The Aside.tsx component is a good pattern reference for slide-in/out drawer components
- StickyAddToCart.tsx shows how to integrate with CartForm and useAside

### Iteration: 2026-01-13
**Story:** US-002 - Style AddedToBagPopup to match design system
**Status:** Complete

**What was done:**
- Applied bg-black text-sand color scheme for dark theme matching On Running style
- Used rounded-card utility for consistent border radius
- Applied type scale utilities: text-s2 for title, text-paragraph for product name, text-small for variant
- Added close button with CrossIcon from @wakey/ui positioned top-right using flexbox justify-between
- Added hover:opacity-70 transition for close button interactivity

**Files changed:**
- apps/website/app/components/AddedToBagPopup.tsx (updated)

**Learnings for future iterations:**
- CrossIcon is exported from @wakey/ui via packages/ui/src/icons/index.ts
- Design system colors are in packages/tailwind-config/theme.css (--color-sand, --color-black, etc.)
- Type scale utilities (text-s2, text-paragraph, etc.) are defined in theme.css as @utility rules
- The rounded-card utility provides responsive border radius (0.3125rem mobile, 0.625rem desktop)

### Iteration: 2026-01-13
**Story:** US-003 - Add product info layout to popup
**Status:** Complete

**What was done:**
- Added flexbox layout with gap-4 for product info section
- Left side: 80px square product thumbnail image (w-20 h-20) with object-cover and rounded corners
- Right side: product title (text-paragraph font-display), variant info (text-small opacity-70), price with currency
- Image conditionally rendered only when product.image exists using shrink-0 to prevent compression
- Used flex-col justify-center for vertical alignment of text content

**Files changed:**
- apps/website/app/components/AddedToBagPopup.tsx (updated)

**Learnings for future iterations:**
- Tailwind w-20 = 5rem = 80px, good for standard thumbnails
- Use shrink-0 on fixed-size elements in flexbox to prevent compression
- object-cover ensures images fill container without distortion
- Build passes successfully with `pnpm build --filter=@wakey/website`

### Iteration: 2026-01-13
**Story:** US-004 - Add action buttons to popup
**Status:** Complete

**What was done:**
- Added 'Your bag (X)' outline button with Link to /cart page, showing dynamic cartCount
- Added 'Checkout' primary button with href to checkoutUrl (Shopify checkout)
- Styled buttons for dark background: outline uses border-sand text-sand bg-transparent, primary uses bg-sand text-black
- Buttons use flex-1 for equal width, rounded-full, font-display text-label
- Added Link import from react-router for internal navigation

**Files changed:**
- apps/website/app/components/AddedToBagPopup.tsx (updated)

**Learnings for future iterations:**
- The existing Button component from @wakey/ui has variants for light backgrounds only
- For dark backgrounds (like popup), need custom button styles matching the inverted color scheme
- Link from react-router works with onClick for closing the popup when navigating
- Use <a> tag with href for external URLs (checkoutUrl is Shopify external checkout)

### Iteration: 2026-01-13
**Story:** US-005 - Position popup above sticky ATC
**Status:** Complete

**What was done:**
- Added fixed positioning to popup container with `fixed bottom-[calc(70px+8px+1rem)] md:bottom-[calc(90px+8px+1rem)]`
- Used calc() to position popup above sticky ATC (70px mobile, 90px desktop) + 8px gap + 1rem padding
- Added `left-0 right-0 z-50 px-4 flex justify-center` for full-width centering
- Inner content div uses `w-full max-w-[600px]` to match sticky ATC width
- Z-index z-50 is higher than sticky ATC's z-40

**Files changed:**
- apps/website/app/components/AddedToBagPopup.tsx (updated)

**Learnings for future iterations:**
- StickyAddToCart uses `fixed bottom-0 left-0 right-0 z-40 p-4` with `max-w-[600px]` inner content
- StickyAddToCart height is h-[70px] on mobile, h-[90px] on desktop
- Using calc() in Tailwind arbitrary values allows combining multiple measurements
- The popup positioning accounts for sticky ATC height + padding (1rem on each side)

### Iteration: 2026-01-13
**Story:** US-006 - Add slide-up animation to popup
**Status:** Complete

**What was done:**
- Added isVisible and shouldRender state variables to control animation timing
- Implemented useEffect to manage animation lifecycle: mount → animate in → animate out → unmount
- Used double requestAnimationFrame pattern to ensure DOM is rendered before animation starts
- Added CSS transition classes: transition-all duration-300 ease-[cubic-bezier(0.19,1,0.22,1)]
- Open state: opacity-100 translate-y-0 (slides up from below)
- Closed state: opacity-0 translate-y-4 (fades out and slides down)
- 300ms timeout to allow close animation to complete before unmounting

**Files changed:**
- apps/website/app/components/AddedToBagPopup.tsx (updated)

**Learnings for future iterations:**
- The design system defines --ease-out-expo as cubic-bezier(0.19,1,0.22,1) in theme.css
- For CSS transitions to work, component must render in initial state first, then update to final state
- Double requestAnimationFrame ensures browser has painted initial state before triggering transition
- Use shouldRender for mounting/unmounting and isVisible for CSS transition states
- setTimeout cleanup function is important to prevent state updates on unmounted components

### Iteration: 2026-01-13
**Story:** US-007 - Integrate popup with StickyAddToCart
**Status:** Complete

**What was done:**
- Replaced cart drawer opening with popup state management in StickyAddToCart
- Added useState for isPopupOpen to track popup visibility
- useEffect triggers setIsPopupOpen(true) when fetcher.state === 'idle' && fetcher.data (successful add)
- Added Suspense/Await pattern to load cart data from root loader (useRouteLoaderData)
- Created AddedToBagPopupWrapper component to use useOptimisticCart for real-time cart count/checkoutUrl
- Popup passes product data (image, title, variant, price) from StickyAddToCart props
- No backdrop added - popup floats without dimming page

**Files changed:**
- apps/website/app/components/StickyAddToCart.tsx (updated)

**Learnings for future iterations:**
- Root loader data is accessed via useRouteLoaderData<RootLoader>('root')
- Cart is a Promise in root loader, use Await component to resolve it
- useOptimisticCart provides optimistic updates for totalQuantity and checkoutUrl
- The cart type is CartApiQueryFragment from storefrontapi.generated
- Wrapper component pattern useful when needing to use hooks with resolved async data
- CartForm fetcher.data becomes truthy after successful cart mutation

