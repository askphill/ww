# Ralph Progress Log

## Codebase Patterns
<!-- Ralph will add discovered patterns here -->

---

## Iterations

### Iteration: 2026-01-14
**Story:** US-001 - Add AI assistant icon to @wakey/ui
**Status:** Complete

**What was done:**
- Created SparkleIcon component in `packages/ui/src/icons/SparkleIcon.tsx`
- Icon features a main 4-point star with two smaller accent sparkles
- Follows existing icon patterns: uses `currentColor` for fill, accepts `className` prop
- Exported from `packages/ui/src/icons/index.ts`

**Files changed:**
- packages/ui/src/icons/SparkleIcon.tsx (created)
- packages/ui/src/icons/index.ts (updated export)

**Learnings for future iterations:**
- Icon pattern uses interface props with `className?: string`
- Icons use `currentColor` for fill/stroke to inherit text color
- New icons should have a unique viewBox matching their design

### Iteration: 2026-01-14
**Story:** US-002 - Add AI assistant button to header
**Status:** Complete

**What was done:**
- Added `SparkleIcon` import to Header.tsx from @wakey/ui
- Added optional `onAssistantToggle` prop to HeaderProps interface
- Created `AssistantButton` component following existing `HeaderButton` pattern
- Button placed between menu toggle and logo in header left side
- Button only renders when `onAssistantToggle` prop is provided (allows conditional display)
- Verified button appears correctly and triggers callback on click via chrome-devtools MCP

**Files changed:**
- apps/website/app/components/Header.tsx (updated)

**Learnings for future iterations:**
- Header uses `HeaderButton` component for consistent button styling (w-8 h-8 md:w-12 md:h-12, hover-scale)
- Header uses grid layout: `grid-cols-[1fr_auto_1fr]` for left/center/right sections
- Optional props allow conditional rendering - good pattern for features being wired up later
- PageLayout.tsx is where Header is instantiated with props from root

### Iteration: 2026-01-14
**Story:** US-003 - Create full-screen overlay container
**Status:** Complete

**What was done:**
- Created `AssistantOverlay` component in `apps/website/app/components/assistant/AssistantOverlay.tsx`
- Component uses `fixed inset-0 z-40` positioning (below header z-50)
- Added animated gradient background with brand colors using CSS keyframes
- Gradient animation runs 25s loop with smooth position shifts
- Created index.ts barrel export for assistant components
- Verified overlay displays correctly and header remains functional via chrome-devtools MCP

**Files changed:**
- apps/website/app/components/assistant/AssistantOverlay.tsx (created)
- apps/website/app/components/assistant/index.ts (created)
- apps/website/app/styles/tailwind.css (added gradient animation)

**Learnings for future iterations:**
- z-index hierarchy: Header z-50, Aside backdrop z-60, Aside drawer z-70 - overlay uses z-40 to stay below header
- Custom CSS classes for animations can be added to tailwind.css (not theme.css) for app-specific styles
- Component uses `aria-hidden` for accessibility when overlay is closed
- Future stories (US-025) will wire up the overlay in PageLayout with proper state management

### Iteration: 2026-01-14
**Story:** US-004 - Add overlay open/close state management
**Status:** Complete

**What was done:**
- Added `onClose` prop to AssistantOverlay component
- Added close button (CrossIcon from @wakey/ui) in top-right corner of overlay
- Implemented body scroll lock using `document.body.style.overflow = 'hidden'`
- Added Escape key handler using event listener with AbortController
- Updated transition to 400ms with fade + scale effect using `--ease-out-expo`
- Added accessibility attributes: `role="dialog"`, `aria-modal={isOpen}`
- Wired up overlay in PageLayout.tsx with useState for testing

**Files changed:**
- apps/website/app/components/assistant/AssistantOverlay.tsx (updated)
- apps/website/app/components/PageLayout.tsx (updated)

**Learnings for future iterations:**
- Follow Aside.tsx pattern for body scroll lock and Escape key handling
- Use AbortController for clean event listener cleanup
- `--ease-out-expo` CSS variable is available for smooth easing
- Close button positioned at `top-4 right-4 md:top-6 md:right-6` matches responsive design
- PageLayout now has overlay wired up - US-025 will just need to clean up the test content

### Iteration: 2026-01-14
**Story:** US-005 - Create conversation state machine hook
**Status:** Complete

**What was done:**
- Created `useAssistantFlow` hook in `apps/website/app/hooks/useAssistantFlow.ts`
- Defined `StepId` type for all 7 conversation steps
- Defined `AnswerValue` type supporting string, string array (multi-select), and Record (forms)
- Implemented state: `currentStepId`, `answers` (typed Record), `history` (step array)
- Implemented actions: `next(answer?)`, `back()`, `reset()`
- Added computed properties: `isFirstStep`, `isLastStep`
- Used STEP_ORDER array for linear progression through steps

**Files changed:**
- apps/website/app/hooks/useAssistantFlow.ts (created)

**Learnings for future iterations:**
- State machine pattern: use STEP_ORDER array to define flow sequence
- History array enables back navigation by popping last entry
- next(answer?) optionally stores answer before advancing
- Type-safe answers using `Partial<Record<StepId, AnswerValue>>`
- Import types from this hook when building step components (US-006, US-007, etc.)

### Iteration: 2026-01-14
**Story:** US-006 - Create conversation step definitions
**Status:** Complete

**What was done:**
- Created `assistantSteps.ts` in `apps/website/app/lib/assistantSteps.ts`
- Defined `StepType` union: 'text' | 'choice' | 'multi-choice' | 'input' | 'recommendation' | 'summary'
- Created `StepOption` interface for choice/multi-choice options with value, label, description
- Created `StepInputField` interface for input step fields with name, type, label, placeholder, required
- Defined variant step interfaces: `TextStep`, `ChoiceStep`, `MultiChoiceStep`, `InputStep`, `RecommendationStep`, `SummaryStep`
- Created `Step` union type combining all step variants
- Populated `ASSISTANT_STEPS` array with all 7 step configurations
- Added helper functions: `getStepById(stepId)`, `getStepIndex(stepId)`, `TOTAL_STEPS`

**Files changed:**
- apps/website/app/lib/assistantSteps.ts (created)

**Learnings for future iterations:**
- Use discriminated union pattern with `type` field to create type-safe step variants
- Step definitions are data-driven - easy to add/modify steps without changing component logic
- Import `StepId` from useAssistantFlow.ts to ensure step IDs stay in sync
- Import step types (Step, ChoiceStep, etc.) when building step renderer components
- Helper functions like `getStepById` will be useful for step rendering components

### Iteration: 2026-01-14
**Story:** US-007 - Create message bubble component
**Status:** Complete

**What was done:**
- Created `AssistantMessage` component in `apps/website/app/components/assistant/AssistantMessage.tsx`
- Component shows typing indicator (3 animated bouncing dots) for 800ms before revealing message
- Message text fades in with slide-up animation after typing delay
- Styled with `bg-sand/90 text-black rounded-card p-6` and `font-display text-s2`
- Added `skipTyping` prop for cases where message should appear immediately
- Added fade-in animation keyframes to tailwind.css
- Exported from assistant index.ts barrel file
- Wired up in PageLayout for testing

**Files changed:**
- apps/website/app/components/assistant/AssistantMessage.tsx (created)
- apps/website/app/components/assistant/index.ts (updated export)
- apps/website/app/components/PageLayout.tsx (updated to use AssistantMessage)
- apps/website/app/styles/tailwind.css (added fade-in animation)

**Learnings for future iterations:**
- Use useState with setTimeout for typing indicator delay pattern
- CSS `animate-bounce` with custom animation-delay creates staggered dot effect
- Keep animations in tailwind.css for app-specific styles (not theme.css)
- Use inline style for animation property when it needs custom keyframes
- max-w-md provides reasonable chat bubble width constraint

### Iteration: 2026-01-14
**Story:** US-008 - Create choice card component
**Status:** Complete

**What was done:**
- Created `AssistantChoiceCard` component in `apps/website/app/components/assistant/AssistantChoiceCard.tsx`
- Cards display option label (font-display text-s2) and optional description (font-body text-body-small)
- Uses `hover-scale` class for desktop hover effect
- Selected state shows `border-softorange` indicator with 2px border
- Staggered fade-in animation using `animationIndex` prop (100ms delay per card)
- Accepts `StepOption` from assistantSteps.ts for type safety
- Updated PageLayout to test choice cards with interest-area step
- Exported from assistant index.ts barrel file

**Files changed:**
- apps/website/app/components/assistant/AssistantChoiceCard.tsx (created)
- apps/website/app/components/assistant/index.ts (updated export)
- apps/website/app/components/PageLayout.tsx (updated to test choice cards)

**Learnings for future iterations:**
- Use `opacity-0` initial state with `animation: fade-in forwards` for staggered entrance
- `animationDelay` via inline style enables dynamic stagger based on index
- Cards use `border-2 border-transparent` by default, switching to `border-softorange` on select
- Import `StepOption` type from assistantSteps.ts for typed option props
- Cards work well with flex-col gap-3 container for proper spacing

### Iteration: 2026-01-14
**Story:** US-009 - Create text input step component
**Status:** Complete

**What was done:**
- Created `AssistantInput` component in `apps/website/app/components/assistant/AssistantInput.tsx`
- Implemented floating labels that move up when focused or filled using CSS transitions
- Added email validation with simple regex pattern and error message display
- Submit button uses disabled prop tied to form validity state
- Inputs styled with `bg-sand text-black rounded-card px-4 pt-6 pb-3`
- Uses `touched` state to only show errors after user has interacted with field
- Exported from assistant index.ts barrel file
- Updated PageLayout to test with name-email step

**Files changed:**
- apps/website/app/components/assistant/AssistantInput.tsx (created)
- apps/website/app/components/assistant/index.ts (updated export)
- apps/website/app/components/PageLayout.tsx (updated to test input component)

**Learnings for future iterations:**
- Floating label pattern: use absolute positioning with top transition from 50% to 2
- Use `touched` state pattern to avoid showing errors before user interaction
- Form validation runs on every render to compute `isFormValid` for button state
- Use `pt-6 pb-3` padding to make room for floating label in "up" position
- Import `StepInputField` type from assistantSteps.ts for typed field props
- Button component from @wakey/ui supports `disabled` prop with opacity styling

### Iteration: 2026-01-14
**Story:** US-010 - Implement back navigation
**Status:** Complete

**What was done:**
- Created `ArrowLeftIcon` component in `packages/ui/src/icons/ArrowLeftIcon.tsx` matching CrossIcon style
- Created `AssistantBackButton` component with visibility toggle and smooth transitions
- Added `showBackButton` and `onBack` props to AssistantOverlay
- Updated AssistantInput to accept `initialValues` prop for pre-populating fields on back navigation
- Wired up full conversation flow in PageLayout using useAssistantFlow hook
- Back button positioned top-left of conversation area, mirroring close button position
- Back button disabled on welcome step, enabled on all other steps

**Files changed:**
- packages/ui/src/icons/ArrowLeftIcon.tsx (created)
- packages/ui/src/icons/index.ts (updated export)
- apps/website/app/components/assistant/AssistantBackButton.tsx (created)
- apps/website/app/components/assistant/AssistantOverlay.tsx (updated)
- apps/website/app/components/assistant/AssistantInput.tsx (updated)
- apps/website/app/components/assistant/index.ts (updated export)
- apps/website/app/components/PageLayout.tsx (updated to wire up full flow)

**Learnings for future iterations:**
- Icon positioning: use matching positions for symmetry (top-left back, top-right close)
- AssistantBackButton uses `disabled` prop with `pointer-events-none` for non-interactive state
- Transition classes: `transition-all duration-300 ease-out` with translate-x for smooth enter/exit
- Use `initialValues` prop pattern to restore form state when navigating back
- PageLayout now has full conversation flow wired up - future stories can build on this foundation
- Back button visibility controlled by `!isFirstStep` from useAssistantFlow hook

### Iteration: 2026-01-14
**Story:** US-011 - Implement welcome step
**Status:** Complete

**What was done:**
- Created `AssistantWelcome` component in `apps/website/app/components/assistant/AssistantWelcome.tsx`
- Component displays SparkleIcon (from @wakey/ui) prominently above the message
- Uses `AssistantMessage` component for the welcome message bubble
- Uses `Button` component (secondary variant) from @wakey/ui for "Let's go" action
- Added staggered fade-in animations: icon first, then message (with typing indicator), then button
- Updated PageLayout to render AssistantWelcome for welcome step, skipping default AssistantMessage render

**Files changed:**
- apps/website/app/components/assistant/AssistantWelcome.tsx (created)
- apps/website/app/components/assistant/index.ts (updated export)
- apps/website/app/components/PageLayout.tsx (updated to use AssistantWelcome)

**Learnings for future iterations:**
- Button component from @wakey/ui does not accept `style` prop - wrap in div for custom animations
- Welcome step needs special handling in PageLayout since it has custom layout (icon + message + button)
- Use `variant="secondary"` for Button on dark backgrounds (sand bg with black text)
- Import `TextStep` type from assistantSteps.ts to access actionLabel property

### Iteration: 2026-01-14
**Story:** US-012 - Implement interest area step
**Status:** Complete

**What was done:**
- Verified that all acceptance criteria were already met by prior implementations
- Step configuration in assistantSteps.ts (US-006) defines the question, options, and descriptions
- AssistantChoiceCard component (US-008) renders the choice cards with proper styling
- PageLayout.tsx already handles 'choice' type steps with auto-advance on selection
- Tested full flow in browser: welcome → interest-area → lifestyle transition works correctly

**Files changed:**
- prd.json (updated to mark story complete)

**Learnings for future iterations:**
- Some user stories may be "integration stories" that verify existing implementations work together
- Always verify in browser even when no code changes are needed - confirms the integration
- Interest-area step uses 'choice' type which auto-advances; lifestyle step uses 'multi-choice' which requires explicit Next button

### Iteration: 2026-01-14
**Story:** US-013 - Implement lifestyle step
**Status:** Complete

**What was done:**
- Added `updateAnswer` function to useAssistantFlow hook for updating selections without advancing
- Added multi-choice step rendering in PageLayout.tsx with toggle selection behavior
- Next button appears after at least one selection using conditional rendering
- Button has staggered animation delay based on number of options
- Verified multi-select works correctly - can select multiple options
- Verified back navigation preserves selections

**Files changed:**
- apps/website/app/hooks/useAssistantFlow.ts (added updateAnswer function)
- apps/website/app/components/PageLayout.tsx (added multi-choice rendering and handlers)

**Learnings for future iterations:**
- Multi-choice steps need updateAnswer to store selections without advancing (unlike single-choice which auto-advances)
- Use `multiChoiceSelections.includes(value)` pattern to check if option is selected in array
- Button component needs to be wrapped in div for custom animation styles
- Conditional rendering `{multiChoiceSelections.length > 0 && ...}` shows Next button only when selections exist

### Iteration: 2026-01-14
**Story:** US-014 - Implement age range step
**Status:** Complete

**What was done:**
- Verified that all acceptance criteria were already met by prior implementations
- Step configuration in assistantSteps.ts (US-006) defines the age-range step as 'choice' type with four options
- PageLayout.tsx already handles 'choice' type steps with auto-advance on selection
- Tested full flow in browser: welcome → interest-area → lifestyle → age-range → name-email transition works correctly
- Clicking an age option immediately advances to the name-email step

**Files changed:**
- prd.json (updated to mark story complete)

**Learnings for future iterations:**
- Age-range step is similar to interest-area step - both are 'choice' type with auto-advance
- Simple 'choice' steps without descriptions still render correctly using AssistantChoiceCard
- Integration verification stories require browser testing even without code changes
- Flow progression: welcome (text) → interest-area (choice) → lifestyle (multi-choice) → age-range (choice) → name-email (input)

### Iteration: 2026-01-14
**Story:** US-015 - Implement name and email step
**Status:** Complete

**What was done:**
- Verified that all acceptance criteria were already met by prior implementations
- Step configuration in assistantSteps.ts (US-006) defines the name-email step with correct message and fields
- AssistantInput component (US-009) handles floating labels, email validation, and disabled button state
- PageLayout.tsx already handles 'input' type steps and passes correct props
- Tested full flow in browser: verified message displays correctly, inputs work, button disabled until valid

**Files changed:**
- prd.json (updated to mark story complete)

**Learnings for future iterations:**
- Name-email step is an integration verification story - all components were already built in earlier stories
- AssistantInput handles all form validation logic including email format checking
- Button disabled state is computed from `isFormValid` which checks all required fields
- The step definitions in assistantSteps.ts drive the UI rendering via type-based conditional rendering in PageLayout

### Iteration: 2026-01-14
**Story:** US-016 - Create recommendation logic
**Status:** Complete

**What was done:**
- Created `getRecommendation` function in `apps/website/app/lib/getRecommendation.ts`
- Defined `Recommendation` interface with productHandle, quantity, and discountPercent
- Function takes `Answers` from useAssistantFlow hook to calculate personalized recommendation
- MVP logic: always returns 'deodorant' product handle
- Quantity based on lifestyle multi-choice selections (1 = qty 1, 2 = qty 2, 3+ = qty 3)
- Discount scales with quantity (5% for 1, 10% for 2, 15% for 3+)

**Files changed:**
- apps/website/app/lib/getRecommendation.ts (created)

**Learnings for future iterations:**
- Import `Answers` type from `~/hooks/useAssistantFlow` for type-safe answer access
- Lifestyle step returns `string[]` (multi-choice), use `Array.isArray()` check and `.length` for count
- Export interface types (like `Recommendation`) so components can import them for type safety
- This function will be used by US-017 (recommendation display) and US-019 (summary view)

### Iteration: 2026-01-14
**Story:** US-017 - Implement recommendation display step
**Status:** Complete

**What was done:**
- Created `AssistantRecommendation` component in `apps/website/app/components/assistant/AssistantRecommendation.tsx`
- Updated API route `api.product.$handle.tsx` to include `price` and `variantId` in response
- Component fetches product data using `useFetcher` from react-router
- Displays personalized message with user's name from answers
- Shows product image with discount badge (e.g., "10% OFF")
- Shows discounted price with original price crossed out
- Displays quantity recommendation ("Recommended: 2 pack") and per-unit pricing for multi-packs
- Wired up in PageLayout.tsx to render on 'recommendation' step type

**Files changed:**
- apps/website/app/components/assistant/AssistantRecommendation.tsx (created)
- apps/website/app/components/assistant/index.ts (updated export)
- apps/website/app/routes/api.product.$handle.tsx (added priceRange and variant price to query)
- apps/website/app/components/PageLayout.tsx (added recommendation step rendering)

**Learnings for future iterations:**
- Use `useFetcher` from react-router for client-side data fetching in components
- API routes can return additional fields by adding to GraphQL query and response object
- Price formatting uses `Intl.NumberFormat` for proper currency display
- Skip the default `AssistantMessage` render for steps that have custom message rendering (welcome, recommendation)
- Access name-email answers via `answers['name-email']` cast to `Record<string, string>`
- `variantId` is needed for US-018 (add to cart functionality)

### Iteration: 2026-01-14
**Story:** US-018 - Add recommended set to cart
**Status:** Complete

**What was done:**
- Created `CheckIcon` component in `packages/ui/src/icons/CheckIcon.tsx` for success state
- Added CartForm integration in AssistantRecommendation component
- Implemented three-state button: default (Add to bag), loading (spinning Smiley), success (Added to your bag!)
- Button uses CSS transitions for smooth state changes (translate-y and opacity)
- Button disabled after successful add to prevent duplicate additions
- Cart quantity derived from `recommendation.quantity` (from getRecommendation logic)
- Verified cart count increases correctly after adding product

**Files changed:**
- packages/ui/src/icons/CheckIcon.tsx (created)
- packages/ui/src/icons/index.ts (updated export)
- apps/website/app/components/assistant/AssistantRecommendation.tsx (added cart functionality)

**Learnings for future iterations:**
- Use CartForm from @shopify/hydrogen with `action={CartForm.ACTIONS.LinesAdd}` for add to cart
- CartForm render prop provides fetcher with state ('idle', 'loading', 'submitting')
- Track `hasAddedToCart` state separately to persist success state after fetcher returns to idle
- Button animation pattern: absolute positioned spans with translate-y transitions for state changes
- Import OptimisticCartLineInput type from @shopify/hydrogen for typed cart lines
- lines array requires `merchandiseId` (variantId) and `quantity` properties

### Iteration: 2026-01-14
**Story:** US-019 - Create routine summary view
**Status:** Complete

**What was done:**
- Created `AssistantSummary` component in `apps/website/app/components/assistant/AssistantSummary.tsx`
- Displays personalized title "[Name]'s Morning Ritual" with user's email
- Shows "YOUR LIFESTYLE" section with selected lifestyle preferences as styled tags
- Shows "RECOMMENDED PRODUCT" section with product image, title, subtitle, qty, pricing, and discount badge
- Includes "Add to bag" button if product wasn't already added in recommendation step
- Added `hasAddedToCart` state in PageLayout to track cart additions across steps
- Added "See my routine" button on recommendation step to advance to summary
- Updated message skip condition to exclude summary step (renders its own content)

**Files changed:**
- apps/website/app/components/assistant/AssistantSummary.tsx (created)
- apps/website/app/components/assistant/index.ts (updated export)
- apps/website/app/components/PageLayout.tsx (added summary rendering and cart state tracking)

**Learnings for future iterations:**
- Summary step follows same pattern as recommendation step - renders its own content container
- Track shared state like `hasAddedToCart` at PageLayout level to pass between steps
- Use `alreadyAddedToCart` prop to sync external cart state with component internal state
- LIFESTYLE_LABELS map converts stored values ('active', 'professional') to display labels
- Use `useEffect` to sync external prop changes to internal state (e.g., alreadyAddedToCart)

